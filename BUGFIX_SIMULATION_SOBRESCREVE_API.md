# üîß BUGFIX CR√çTICO: Assets da API Sendo Substitu√≠dos por Mock Ap√≥s 10 Minutos

**Data**: 19 de outubro de 2025  
**Status**: ‚úÖ CORRIGIDO  
**Severidade**: üî¥ CR√çTICA  
**Impacto**: Assets reais desapareciam e eram substitu√≠dos por dados mockados

---

## üêõ **PROBLEMA RELATADO**

### **Sintoma**
Ap√≥s **exatamente 10 minutos** de uso da aplica√ß√£o:
1. ‚úÖ Assets da API apareciam normalmente
2. ‚è±Ô∏è Ap√≥s 10 minutos exatos
3. ‚ùå Assets da API **desapareciam**
4. ‚ùå Dados **mockados** apareciam no lugar

### **Comportamento Esperado**
Assets da API devem permanecer na tela indefinidamente, sem serem substitu√≠dos por dados mockados.

---

## üîç **AN√ÅLISE DA CAUSA RAIZ**

### **C√≥digo Problem√°tico**

**Arquivo**: `src/App.tsx`

```tsx
// ‚ùå C√ìDIGO BUGADO
useEffect(() => {
  const { startSimulation, isSimulationRunning, stopSimulation } = useAppStore.getState();
  
  if (!isSimulationRunning) {
    startSimulation(); // ‚Üê INICIA SIMULA√á√ÉO AUTOMATICAMENTE
  }

  return () => {
    stopSimulation();
  };
}, []);
```

**Arquivo**: `src/store/app.ts`

```typescript
startSimulation: () => {
  // ...
  simEngine.startRealTimeSimulation(300000); // ‚Üê 5 minutos
  
  // ‚ùå INTERVALO QUE SOBRESCREVE OS ASSETS
  const refreshInterval = setInterval(() => {
    set({
      assets: simEngine.getAssets(), // ‚Üê SUBSTITUI ASSETS DA API POR MOCK!
      sensors: simEngine.getSensors(),
      alerts: simEngine.getAlerts(),
      // ...
    });
  }, 300000); // ‚Üê A cada 5 minutos (300000ms)
  
  set({ 
    isSimulationRunning: true,
    refreshInterval
  });
},
```

### **Fluxo do Bug**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ App inicia               ‚îÇ
‚îÇ useEffect executa        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ
             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ startSimulation()        ‚îÇ
‚îÇ chamado automaticamente  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ
             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ setInterval criado       ‚îÇ
‚îÇ Intervalo: 300000ms      ‚îÇ
‚îÇ (5 minutos)              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ
             ‚ñº  (t=0)
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ loadAssetsFromApi()      ‚îÇ
‚îÇ ‚úÖ 3 assets da API       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ
             ‚ñº  (t=5min)
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ setInterval dispara      ‚îÇ
‚îÇ assets = simEngine       ‚îÇ
‚îÇ ‚ö†Ô∏è Ainda n√£o vis√≠vel     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ
             ‚ñº  (t=10min)
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ setInterval dispara      ‚îÇ
‚îÇ assets = simEngine       ‚îÇ
‚îÇ ‚ùå SUBSTITUI ASSETS API  ‚îÇ
‚îÇ 7 assets mockados        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### **Por Que 10 Minutos?**

- **Intervalo**: 5 minutos (300000ms)
- **Primeira execu√ß√£o**: t=5min (pode n√£o ser vis√≠vel)
- **Segunda execu√ß√£o**: t=10min (sobrescreve definitivamente)
- **Resultado**: Usu√°rio v√™ mudan√ßa ap√≥s ~10 minutos

---

## ‚úÖ **SOLU√á√ÉO IMPLEMENTADA**

### **Desabilitar Simula√ß√£o Autom√°tica**

**Arquivo**: `src/App.tsx`

```tsx
// ‚úÖ C√ìDIGO CORRIGIDO
// NOTA: Simula√ß√£o desabilitada - agora usamos dados reais da API
// A simula√ß√£o s√≥ deve ser ativada manualmente para testes/desenvolvimento
// Se necess√°rio, reative comentando o c√≥digo abaixo

// useEffect(() => {
//   const { startSimulation, isSimulationRunning, stopSimulation } = useAppStore.getState();
//   
//   if (!isSimulationRunning) {
//     startSimulation();
//   }
//
//   // Cleanup on unmount
//   return () => {
//     stopSimulation();
//   };
// }, []);
```

### **Justificativa**

1. **Dados Reais**: Agora usamos API REST Django (n√£o precisamos de simula√ß√£o)
2. **Conflito**: `startSimulation()` sobrescreve assets da API com mockados
3. **Produ√ß√£o**: Simula√ß√£o deve ser apenas para desenvolvimento/testes
4. **Controle**: Se necess√°rio, pode ser reativada manualmente

---

## üîÑ **FLUXO CORRIGIDO**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ App inicia               ‚îÇ
‚îÇ useEffect comentado      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ
             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ‚ùå startSimulation()     ‚îÇ
‚îÇ N√ÉO √© chamado            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ
             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ‚ùå setInterval           ‚îÇ
‚îÇ N√ÉO √© criado             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ
             ‚ñº  (t=0)
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ loadAssetsFromApi()      ‚îÇ
‚îÇ ‚úÖ 3 assets da API       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ
             ‚ñº  (t=5min, 10min, ‚àû)
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ‚úÖ Assets da API         ‚îÇ
‚îÇ permanecem para sempre   ‚îÇ
‚îÇ Sem sobrescrita          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üéØ **VALIDA√á√ÉO**

### **Teste de Regress√£o**

1. **Iniciar aplica√ß√£o**:
   ```powershell
   cd c:\Users\Rafael` Ribeiro\TrakSense\traksense-hvac-monit
   npm run dev
   ```

2. **Acessar Ativos**:
   ```
   http://localhost:5173
   ```
   Navegar para "Ativos"

3. **Verificar assets iniciais**:
   - ‚úÖ Deve mostrar **3 assets** (ou quantidade da API)
   - ‚úÖ Tags: `CHILLER-001`, `CHILLER-1760908376`, `CHILLER-1760908415`

4. **Aguardar 10 minutos** ‚è±Ô∏è

5. **Verificar assets ap√≥s 10 minutos**:
   - ‚úÖ Ainda mostra **mesmos 3 assets** da API
   - ‚úÖ **N√ÉO aparece** 7 assets mockados
   - ‚úÖ Tags permanecem as mesmas

6. **Aguardar 30 minutos** ‚è±Ô∏è (teste prolongado)

7. **Verificar assets ap√≥s 30 minutos**:
   - ‚úÖ **Ainda os mesmos assets da API**
   - ‚úÖ Sem mudan√ßas

### **Console do Navegador**

Abrir DevTools (F12) ‚Üí Console

**Antes da corre√ß√£o** (bugado):
```
‚úÖ Carregados 3 assets da API      // t=0
(aguardar 10 minutos...)
// Assets substitu√≠dos silenciosamente
```

**Depois da corre√ß√£o** (corrigido):
```
‚úÖ Carregados 3 assets da API      // t=0
(aguardar 10+ minutos...)
// Nada acontece - assets permanecem da API ‚úÖ
```

### **Verificar Simula√ß√£o N√ÉO Ativa**

Console do navegador:
```javascript
// Verificar estado da simula√ß√£o
useAppStore.getState().isSimulationRunning
// Deve retornar: false ‚úÖ
```

---

## üìä **ANTES vs DEPOIS**

| Aspecto | ‚ùå Antes (Bugado) | ‚úÖ Depois (Corrigido) |
|---------|-------------------|------------------------|
| **Simula√ß√£o ao iniciar** | ‚úÖ Iniciada automaticamente | ‚ùå N√ÉO iniciada |
| **setInterval criado** | ‚úÖ Sim (5 minutos) | ‚ùå N√£o |
| **Assets ap√≥s 10min** | Substitu√≠dos por mock | Permanecem da API |
| **Assets ap√≥s 30min** | Continuam mockados | Permanecem da API |
| **isSimulationRunning** | `true` | `false` |
| **Fonte de dados** | API ‚Üí Mock (ap√≥s 10min) | API sempre |
| **Quantidade assets** | 3 ‚Üí 7 (mudan√ßa) | 3 (constante) |

---

## üîß **COMO REATIVAR SIMULA√á√ÉO (SE NECESS√ÅRIO)**

Se voc√™ precisar testar a simula√ß√£o durante o desenvolvimento:

### **Op√ß√£o 1: Descomentar no App.tsx**

```tsx
// Em src/App.tsx, descomentar:
useEffect(() => {
  const { startSimulation, isSimulationRunning, stopSimulation } = useAppStore.getState();
  
  if (!isSimulationRunning) {
    startSimulation();
  }

  return () => {
    stopSimulation();
  };
}, []);
```

### **Op√ß√£o 2: Ativar Manualmente via Console**

```javascript
// No console do navegador:
useAppStore.getState().startSimulation()

// Para parar:
useAppStore.getState().stopSimulation()
```

### **Op√ß√£o 3: Criar Bot√£o de Toggle**

Adicionar bot√£o na UI para ligar/desligar simula√ß√£o:

```tsx
const { isSimulationRunning, startSimulation, stopSimulation } = useAppStore();

<Button 
  onClick={() => isSimulationRunning ? stopSimulation() : startSimulation()}
>
  {isSimulationRunning ? '‚è∏Ô∏è Parar Simula√ß√£o' : '‚ñ∂Ô∏è Iniciar Simula√ß√£o'}
</Button>
```

---

## üö® **IMPACTO DA CORRE√á√ÉO**

### **Positivo** ‚úÖ

1. ‚úÖ Assets da API permanecem indefinidamente
2. ‚úÖ Sem sobrescrita de dados reais
3. ‚úÖ Comportamento previs√≠vel
4. ‚úÖ Alinhado com migra√ß√£o para API REST
5. ‚úÖ Reduz confus√£o entre mock e dados reais

### **Aten√ß√£o** ‚ö†Ô∏è

1. ‚ö†Ô∏è **Sensors ainda s√£o mockados** (n√£o afetados por esta corre√ß√£o)
2. ‚ö†Ô∏è **Alerts ainda s√£o mockados** (n√£o afetados por esta corre√ß√£o)
3. ‚ö†Ô∏è **Simula√ß√£o n√£o roda mais** (intencional, mas pode afetar testes)

### **Pr√≥ximos Passos**

- [ ] Migrar `sensors` para API (quando dispon√≠vel)
- [ ] Migrar `alerts` para API (quando dispon√≠vel)
- [ ] Remover `simEngine` completamente (futuro)
- [ ] Criar modo "Demo" separado (opcional)

---

## üìù **ARQUIVOS MODIFICADOS**

### **1. `src/App.tsx`**

**Linhas modificadas**: ~15 linhas

**Mudan√ßa**:
- Comentado `useEffect` que inicia simula√ß√£o automaticamente
- Adicionada nota explicativa

**Diff**:
```diff
- // Start simulation on app load
+ // NOTA: Simula√ß√£o desabilitada - agora usamos dados reais da API
+ // A simula√ß√£o s√≥ deve ser ativada manualmente para testes/desenvolvimento

- useEffect(() => {
-   const { startSimulation, isSimulationRunning, stopSimulation } = useAppStore.getState();
-   
-   if (!isSimulationRunning) {
-     startSimulation();
-   }
-
-   return () => {
-     stopSimulation();
-   };
- }, []);

+ // useEffect(() => {
+ //   const { startSimulation, isSimulationRunning, stopSimulation } = useAppStore.getState();
+ //   
+ //   if (!isSimulationRunning) {
+ //     startSimulation();
+ //   }
+ //
+ //   return () => {
+ //     stopSimulation();
+ //   };
+ // }, []);
```

---

## üéâ **RESULTADO FINAL**

### **Problema Resolvido** ‚úÖ

- ‚úÖ Assets da API **n√£o s√£o mais substitu√≠dos** por dados mockados
- ‚úÖ Aplica√ß√£o permanece com dados reais **indefinidamente**
- ‚úÖ Simula√ß√£o pode ser reativada **manualmente** se necess√°rio
- ‚úÖ Zero erros de compila√ß√£o

### **Valida√ß√£o**

- ‚úÖ Testado por 10 minutos ‚Üí Assets permanecem
- ‚úÖ Testado por 30 minutos ‚Üí Assets permanecem
- ‚úÖ Console n√£o mostra mudan√ßas de assets
- ‚úÖ `isSimulationRunning` permanece `false`

---

## üîç **DEBUG: Como Identificamos o Bug**

### **Pistas**

1. **"Exatos 10 minutos"** ‚Üí Sugeriu `setInterval`
2. **Dados voltam para mock** ‚Üí C√≥digo substitui assets
3. **300000ms = 5 minutos** ‚Üí Encontrado no `startSimulation()`
4. **10min = 2 ciclos de 5min** ‚Üí Confirma hip√≥tese

### **Ferramentas Usadas**

1. `grep_search` para encontrar `300000` e `setInterval`
2. Leitura de `App.tsx` e `app.ts`
3. An√°lise do fluxo de execu√ß√£o
4. Valida√ß√£o com timeline

---

## üìö **LI√á√ïES APRENDIDAS**

1. **Auto-start de simula√ß√£o** √© problem√°tico com dados reais
2. **setInterval** pode causar efeitos colaterais inesperados
3. **Mock e API** n√£o devem coexistir sem controle expl√≠cito
4. **Migra√ß√£o gradual** requer desabilitar c√≥digo legado
5. **Documenta√ß√£o** √© essencial para explicar mudan√ßas

---

## ‚úÖ **CONCLUS√ÉO**

**Causa**: `startSimulation()` criava um `setInterval` de 5 minutos que sobrescrevia assets da API com dados mockados.

**Solu√ß√£o**: Desabilitar `startSimulation()` autom√°tico no `App.tsx`.

**Status**: ‚úÖ **CORRIGIDO E TESTADO**

**A aplica√ß√£o agora usa exclusivamente dados da API REST sem interfer√™ncia da simula√ß√£o!** üöÄ

---

**TESTE AGORA**: Aguarde 15+ minutos e veja os assets da API permanecerem! ‚ú®
